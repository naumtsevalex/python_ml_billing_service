# Changelog

## [Unreleased]


#### Patch 11
- Теперь воркеры созвращают только статус и номер таски - а внутри функций уже идут в бд за инфой по таске 
- Отказываются от STT и делаю простую модель 
- Пишу текстом анекдот случайный из базы за 1 токен, дополнителньо озвучиваю за 5 токенов
- Анекдоты добываю и кладу в бд отдельным скриптом | parse_jokes.py
- Разнес joke_router.py в отдельный роутер 
> feat: в брокере передается только id таски - полезная инфа получается/кладется все через бд | делаю простую бизнес модель: даю рандомный анекдот из базы за 1 токен, за 5 еще и озвучиваю | паршу анекдоты parse_jokes.py |  joke_router.py отдельный скрипт
  

#### Patch 10 
- Пофиксил По голосу - возвращает текст распознаный 
> feat: (user) voice -> text
- Добавил README.md и DETAILS.md - для более детального погружения
> doc: patch README.md and add DETAILS.md


#### Patch 9
- Разнес на два файла MessageService -> BotService + ClientRabbitMQService(перенес сюда process_message) 
> refactor:MessageService -> BotService + ClientRabbitMQService(перенес сюда process_message)
- Добавил простенький BillingService скрывающий бизнес-логику билинга - сформировал политику билинга(=отдаем всегда результат если баланс >0 [сильно в минус не уйти! TODO: обработать это], иначе предлагаем пополнить счет)
> feat: add BillingService & dev in bot.py 


### Path 8
- Сделал RPC - для каждого юзера одна очередь уникальная => теперь в бот прилетает финальный ответ!
- Расклеил MessageService на бизнесБота и RPC запрос
- Весь результат о таске грепаю из БД => Оставляю только успешный результат от воркера 
- Бизнес логику стоимости убираю из TaskService (воркера)
> feat: RPC=one user one queue & split MessageService on BotService + ClientRPC & grep final result tasf from bd & billins logic delete from TaskService(=worker)


### Path 7
- Сделал регистрацию пользователя и взятие о его информации в мидлваре 
- Добавил небольшую функциональность уже боту= /start /balance /help + блокировку пользователя 
> add UserRegistratino midlware & first buisness bot handlers: /start /balance /help


### Patch 6
- Сделал _refresh_iam_token | нужно запрашивать (и отдавать постоянный OAUTH_TOKEN) IAM_TOKEN каждый день. (или еще раньше) Сделал перезапрос при каждом неудачном(=expired Token) запросе
-  Добавил role админ ADMIN, CHILL_BOY, BANNED и отправка только админу стартовое тестовое сообщение
- ENAM для названий очереди 

### Patch 5
- Тут пофискил отсутсвия сообщения от ТГ и дошел до баги тг не ловит из очереди result готовый ответ

### Patch 4 
- Попытка пофиксить ошибки связанные с очередью? пофиксил 
- Дошел до вызова TTS и созранения - но потом ошибки полились которые поправил - теперь лог вообще пропал 
- как будто осталось прям совсем чут чуть

### Patch 3
- Весь проект переведён на единый файл `.env` с комментариями и разделами по сервисам. Удалён `envs.sh`, все переменные централизованы.
- Интеграция с RabbitMQ: реализованы две очереди (основная и reply_to), бот и воркер обмениваются задачами и результатами асинхронно.
- Введён синглтон для работы с базой данных во всех сервисах.
- Логирование действий теперь ведётся и в базу (таблица logs), и в stdout для удобства отладки.
- Все сервисы (бот, воркер, RabbitMQ, PostgreSQL, Prometheus, Grafana) запускаются одной командой через docker-compose, добавлены healthcheck и depends_on для корректного порядка запуска.
- Мониторинг (Prometheus, Grafana) только запущен, интеграция с метриками будет тестироваться далее.
- README.md обновлён: добавлены инструкции по запуску, настройке переменных окружения и миграциям.

### Patch 2
- Перепроектирована структура БД: теперь telegram_id — PRIMARY KEY для пользователей и внешний ключ для всех связанных таблиц (balances, logs, tasks, transactions).
- Полностью обновлены все модели ORM под новую схему (user, balance, transaction, task, log).
- Исправлены все обращения к user.id на user.telegram_id в коде бота и логирования.
- Проведена полная пересоздача миграций Alembic и очистка базы для корректной работы с новой схемой.
- Реализовано логирование действий пользователя (регистрация, старт, любое сообщение) в таблицу logs.
- Бот теперь использует telegram_id как основной идентификатор пользователя во всех операциях.
- Все параметры (токены, строки подключения) берутся из переменных окружения через envs.sh.
- Реализован и протестирован эхо-бот в Telegram: бот отвечает на текстовые сообщения, регистрирует пользователей и логирует действия.
- Проверена и подтверждена корректная работа регистрации, логирования и взаимодействия с базой.

### Patch 1
- Инициализирован проект.
- Добавлен docker-compose.yml с сервисами: rabbitmq, postgres, prometheus, grafana.
- Создана базовая структура для мониторинга (monitoring/prometheus.yml).
- Описаны модели данных через SQLAlchemy ORM (users, balances, transactions, tasks, logs).
- Настроен Alembic для автоматических миграций.
- Выполнена первая миграция — все таблицы созданы в PostgreSQL. 