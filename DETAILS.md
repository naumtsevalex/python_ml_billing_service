# üìö –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üèóÔ∏è –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```mermaid
graph TD
    User[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å] -->|–°–æ–æ–±—â–µ–Ω–∏—è| Bot[Telegram Bot]
    Bot -->|–ó–∞–¥–∞—á–∏| RabbitMQ[RabbitMQ]
    RabbitMQ -->|–û–±—Ä–∞–±–æ—Ç–∫–∞| Worker[Worker]
    Worker -->|API| Yandex[Yandex SpeechKit]
    Bot -->|–î–∞–Ω–Ω—ã–µ| DB[(PostgreSQL)]
    Worker -->|–î–∞–Ω–Ω—ã–µ| DB
    Worker -->|–ú–µ—Ç—Ä–∏–∫–∏| Prometheus[Prometheus]
    Prometheus -->|–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è| Grafana[Grafana]
```

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ü—Ä–æ–µ–∫—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –∏ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:

### 1. Telegram Bot (`/bot`)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥—å
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—Ç –≤–æ—Ä–∫–µ—Ä–∞
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 2. Worker (`/worker`)
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á
- –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ —Ä–µ—á—å (TTS)
- –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –≤ —Ç–µ–∫—Å—Ç (STT)
- –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –æ—á–µ—Ä–µ–¥—å –æ—Ç–≤–µ—Ç–æ–≤

### 3. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (`/db`)
- PostgreSQL –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- –ú–∏–≥—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Alembic
- –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö –≤ `/models`
- –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:
  - `users` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
  - `balances` - –±–∞–ª–∞–Ω—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  - `jokes` - –∫–æ–ª–ª–µ–∫—Ü–∏—è –∞–Ω–µ–∫–¥–æ—Ç–æ–≤
  - `tasks` - –∏—Å—Ç–æ—Ä–∏—è –∑–∞–¥–∞—á
  - `transactions` - –∏—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

### 4. AI –°–µ—Ä–≤–∏—Å—ã (`/ai_studio`)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Yandex SpeechKit
- TTS (Text-to-Speech):
  - –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∞–Ω–µ–∫–¥–æ—Ç–æ–≤ –≤ —Ä–µ—á—å
  - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–æ–ª–æ—Å–∞ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- STT (Speech-to-Text):
  - –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ

### 5. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (`/monitoring`)
- Prometheus –¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫
- Grafana –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
- –î–∞—à–±–æ—Ä–¥—ã –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
  - –ö–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
  - –í—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
  - –û—à–∏–±–æ–∫
  - –ë–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### –Ø–∑—ã–∫–∏ –∏ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏
- Python 3.11+
- aiogram 3.x (Telegram Bot Framework)
- SQLAlchemy (ORM)
- Alembic (–º–∏–≥—Ä–∞—Ü–∏–∏)
- aio-pika (RabbitMQ –∫–ª–∏–µ–Ω—Ç)
- Yandex SpeechKit SDK

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- PostgreSQL 15
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –¥—Ä–∞–π–≤–µ—Ä—ã
- –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
  ```sql
  -- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
  CREATE TABLE users (
      telegram_id BIGINT PRIMARY KEY,
      username TEXT,
      role TEXT DEFAULT 'CHILL_BOY',
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  );

  -- –ë–∞–ª–∞–Ω—Å—ã
  CREATE TABLE balances (
      user_id BIGINT PRIMARY KEY REFERENCES users(telegram_id),
      balance INTEGER DEFAULT 20,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  );

  -- –ê–Ω–µ–∫–¥–æ—Ç—ã
  CREATE TABLE jokes (
      id SERIAL PRIMARY KEY,
      text TEXT NOT NULL,
      category TEXT,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  );

  -- –ó–∞–¥–∞—á–∏
  CREATE TABLE tasks (
      id TEXT PRIMARY KEY,
      user_id BIGINT REFERENCES users(telegram_id),
      type TEXT NOT NULL,
      status TEXT NOT NULL,
      payload TEXT,
      result TEXT,
      cost INTEGER,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      finished_at TIMESTAMP
  );

  -- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  CREATE TABLE transactions (
      id SERIAL PRIMARY KEY,
      user_id BIGINT REFERENCES users(telegram_id),
      type TEXT NOT NULL,
      amount INTEGER NOT NULL,
      reason TEXT,
      task_id TEXT,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  );
  ```

### –û—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- RabbitMQ
- –û—á–µ—Ä–µ–¥–∏:
  - `tasks` - –¥–ª—è –∑–∞–¥–∞—á
  - `reply_to` - –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤

### –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è
- Docker
- Docker Compose
- –ú–Ω–æ–≥–æ—ç—Ç–∞–ø–Ω—ã–µ —Å–±–æ—Ä–∫–∏
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
python_ml_billing_service/
‚îú‚îÄ‚îÄ alembic/              # –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ versions/        # –§–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π
‚îÇ   ‚îî‚îÄ‚îÄ env.py          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Alembic
‚îÇ
‚îú‚îÄ‚îÄ bot/                 # Telegram –±–æ—Ç
‚îÇ   ‚îú‚îÄ‚îÄ middleware/     # Middleware –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ routers/       # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
‚îÇ   ‚îî‚îÄ‚îÄ bot.py         # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –±–æ—Ç–∞
‚îÇ
‚îú‚îÄ‚îÄ worker/             # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–¥–∞—á
‚îÇ   ‚îú‚îÄ‚îÄ services/      # –°–µ—Ä–≤–∏—Å—ã –≤–æ—Ä–∫–µ—Ä–∞
‚îÇ   ‚îî‚îÄ‚îÄ worker.py      # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –≤–æ—Ä–∫–µ—Ä–∞
‚îÇ
‚îú‚îÄ‚îÄ db/                # –†–∞–±–æ—Ç–∞ —Å –ë–î
‚îÇ   ‚îî‚îÄ‚îÄ database.py    # –ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
‚îÇ
‚îú‚îÄ‚îÄ models/            # –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ user.py       # –ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îÇ   ‚îú‚îÄ‚îÄ balance.py    # –ú–æ–¥–µ–ª—å –±–∞–ª–∞–Ω—Å–∞
‚îÇ   ‚îú‚îÄ‚îÄ task.py       # –ú–æ–¥–µ–ª—å –∑–∞–¥–∞—á–∏
‚îÇ   ‚îú‚îÄ‚îÄ joke.py       # –ú–æ–¥–µ–ª—å –∞–Ω–µ–∫–¥–æ—Ç–∞
‚îÇ   ‚îî‚îÄ‚îÄ base.py       # –ë–∞–∑–æ–≤–∞—è –º–æ–¥–µ–ª—å
‚îÇ
‚îú‚îÄ‚îÄ services/          # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ bot_service.py
‚îÇ   ‚îú‚îÄ‚îÄ billing_service.py
‚îÇ   ‚îî‚îÄ‚îÄ joke_service.py
‚îÇ
‚îú‚îÄ‚îÄ ai_studio/         # AI —Å–µ—Ä–≤–∏—Å—ã
‚îÇ   ‚îú‚îÄ‚îÄ tts.py        # Text-to-Speech
‚îÇ   ‚îî‚îÄ‚îÄ stt.py        # Speech-to-Text
‚îÇ
‚îú‚îÄ‚îÄ utils/             # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ file_utils.py
‚îÇ   ‚îî‚îÄ‚îÄ utils.py
‚îÇ
‚îú‚îÄ‚îÄ monitoring/        # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
‚îÇ   ‚îú‚îÄ‚îÄ prometheus.yml
‚îÇ   ‚îî‚îÄ‚îÄ grafana/
‚îÇ
‚îú‚îÄ‚îÄ docker-compose.yml # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Docker
‚îú‚îÄ‚îÄ Dockerfile        # –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞
‚îî‚îÄ‚îÄ requirements.txt  # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É –±–æ—Ç—É
   - Middleware —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å

2. **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏**
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–∞–¥–∞—á–∏
   - –ó–∞–¥–∞—á–∞ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –ë–î
   - –ó–∞–¥–∞—á–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ—Ä–∫–µ—Ä–æ–º**
   - –í–æ—Ä–∫–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–¥–∞—á—É
   - –í—ã–ø–æ–ª–Ω—è–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤ –ë–î
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –æ—á–µ—Ä–µ–¥—å –æ—Ç–≤–µ—Ç–æ–≤

4. **–û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞**
   - –ë–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
   - –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Prometheus –º–µ—Ç—Ä–∏–∫–∏
- `bot_requests_total` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
- `bot_processing_time` - –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `bot_errors_total` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
- `user_balance` - –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### Grafana –¥–∞—à–±–æ—Ä–¥—ã
- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- –ì—Ä–∞—Ñ–∏–∫–∏ –æ—à–∏–±–æ–∫
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—á–µ—Ä–µ–¥–µ–π
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –ø–µ—Ä–µ–¥ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π
- –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞

## üöÄ –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ—Ä–∫–µ—Ä–æ–≤
- –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –ë–î
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

- –õ–æ–≥–∏ –≤ stdout
- –ó–∞–ø–∏—Å—å –≤ –ë–î
- –ú–µ—Ç—Ä–∏–∫–∏ –≤ Prometheus
- –¢—Ä–µ–π—Å–∏–Ω–≥ –æ–ø–µ—Ä–∞—Ü–∏–π

## üîÑ –î–∏–∞–≥—Ä–∞–º–º—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```mermaid
sequenceDiagram
    actor User as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant Bot as Telegram Bot
    participant DB as PostgreSQL
    participant Middleware as UserRegistrationMiddleware

    User->>Bot: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    Bot->>Middleware: –ü–µ—Ä–µ–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
    Middleware->>DB: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    alt –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        DB-->>Middleware: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç null
        Middleware->>DB: –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        Middleware->>DB: –°–æ–∑–¥–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å (20 –∫—Ä–µ–¥–∏—Ç–æ–≤)
        DB-->>Middleware: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ
    else –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        DB-->>Middleware: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    end
    Middleware-->>Bot: –î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    Bot-->>User: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–Ω–µ–∫–¥–æ—Ç–∞
```mermaid
sequenceDiagram
    actor User as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant Bot as Telegram Bot
    participant DB as PostgreSQL
    participant RabbitMQ as RabbitMQ
    participant Worker as Worker

    User->>Bot: –ö–æ–º–∞–Ω–¥–∞ /joke
    Bot->>DB: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    alt –ë–∞–ª–∞–Ω—Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π
        Bot->>RabbitMQ: –°–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á—É (correlation_id, reply_to)
        RabbitMQ->>Worker: –ü–µ—Ä–µ–¥–∞–µ—Ç –∑–∞–¥–∞—á—É
        Worker->>DB: –ü–æ–ª—É—á–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π –∞–Ω–µ–∫–¥–æ—Ç
        Worker->>DB: –°–ø–∏—Å—ã–≤–∞–µ—Ç –∫—Ä–µ–¥–∏—Ç—ã
        Worker->>DB: –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
        Worker-->>RabbitMQ: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ reply_to
        RabbitMQ-->>Bot: –ü–µ—Ä–µ–¥–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        Bot-->>User: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞–Ω–µ–∫–¥–æ—Ç
    else –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤
        Bot-->>User: –°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ –∫—Ä–µ–¥–∏—Ç–æ–≤
    end
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –∞–Ω–µ–∫–¥–æ—Ç–∞
```mermaid
sequenceDiagram
    actor User as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant Bot as Telegram Bot
    participant DB as PostgreSQL
    participant RabbitMQ as RabbitMQ
    participant Worker as Worker
    participant TTS as Yandex SpeechKit

    User->>Bot: –ö–æ–º–∞–Ω–¥–∞ /joke_voice
    Bot->>DB: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    alt –ë–∞–ª–∞–Ω—Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π
        Bot->>RabbitMQ: –°–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á—É (correlation_id, reply_to)
        RabbitMQ->>Worker: –ü–µ—Ä–µ–¥–∞–µ—Ç –∑–∞–¥–∞—á—É
        Worker->>DB: –ü–æ–ª—É—á–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π –∞–Ω–µ–∫–¥–æ—Ç
        Worker->>TTS: –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –≤ —Ä–µ—á—å
        TTS-->>Worker: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞—É–¥–∏–æ
        Worker->>DB: –°–ø–∏—Å—ã–≤–∞–µ—Ç –∫—Ä–µ–¥–∏—Ç—ã
        Worker->>DB: –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
        Worker-->>RabbitMQ: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ reply_to
        RabbitMQ-->>Bot: –ü–µ—Ä–µ–¥–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        Bot-->>User: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    else –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤
        Bot-->>User: –°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ –∫—Ä–µ–¥–∏—Ç–æ–≤
    end
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
```mermaid
sequenceDiagram
    actor User as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant Bot as Telegram Bot
    participant DB as PostgreSQL
    participant Middleware as BalanceMiddleware

    User->>Bot: –ö–æ–º–∞–Ω–¥–∞ /balance
    Bot->>Middleware: –ü–µ—Ä–µ–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
    Middleware->>DB: –ü–æ–ª—É—á–∞–µ—Ç –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    DB-->>Middleware: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–∞–ª–∞–Ω—Å
    Middleware-->>Bot: –î–æ–±–∞–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    Bot-->>User: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∞–ª–∞–Ω—Å–µ
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
```mermaid
sequenceDiagram
    actor User as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant Bot as Telegram Bot
    participant DB as PostgreSQL
    participant RabbitMQ as RabbitMQ
    participant Worker as Worker
    participant TTS as Yandex SpeechKit

    User->>Bot: –ö–æ–º–∞–Ω–¥–∞ /joke_voice
    Bot->>DB: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    alt –ë–∞–ª–∞–Ω—Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π
        Bot->>RabbitMQ: –°–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á—É
        RabbitMQ->>Worker: –ü–µ—Ä–µ–¥–∞–µ—Ç –∑–∞–¥–∞—á—É
        Worker->>DB: –ü–æ–ª—É—á–∞–µ—Ç –∞–Ω–µ–∫–¥–æ—Ç
        Worker->>TTS: –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –≤ —Ä–µ—á—å
        alt –û—à–∏–±–∫–∞ TTS
            TTS-->>Worker: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É
            Worker->>DB: –û—Ç–º–µ–Ω—è–µ—Ç —Å–ø–∏—Å–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤
            Worker-->>RabbitMQ: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—à–∏–±–∫—É –≤ reply_to
            RabbitMQ-->>Bot: –ü–µ—Ä–µ–¥–∞–µ—Ç –æ—à–∏–±–∫—É
            Bot-->>User: –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        else –£—Å–ø–µ—Ö
            TTS-->>Worker: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞—É–¥–∏–æ
            Worker->>DB: –°–ø–∏—Å—ã–≤–∞–µ—Ç –∫—Ä–µ–¥–∏—Ç—ã
            Worker-->>RabbitMQ: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            RabbitMQ-->>Bot: –ü–µ—Ä–µ–¥–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            Bot-->>User: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        end
    else –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤
        Bot-->>User: –°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ –∫—Ä–µ–¥–∏—Ç–æ–≤
    end
```
